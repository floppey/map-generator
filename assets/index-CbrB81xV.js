var X=Object.defineProperty;var R=t=>{throw TypeError(t)};var Y=(t,e,o)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var w=(t,e,o)=>Y(t,typeof e!="symbol"?e+"":e,o),Z=(t,e,o)=>e.has(t)||R("Cannot "+o);var f=(t,e,o)=>(Z(t,e,"read from private field"),o?o.call(t):e.get(t)),m=(t,e,o)=>e.has(t)?R("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,o),u=(t,e,o,n)=>(Z(t,e,"write to private field"),n?n.call(t,o):e.set(t,o),o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(s){if(s.ep)return;s.ep=!0;const l=o(s);fetch(s.href,l)}})();const A=t=>(t??"").split("").reverse().join("");class q{constructor(e,o,n,s){w(this,"x");w(this,"y");w(this,"grid");w(this,"options");w(this,"collapsed");this.grid=e,this.x=o,this.y=n,this.options=s}collapse(){if(!this.collapsed)this.collapsed=this.options[Math.floor(Math.random()*this.options.length)];else throw console.log("Cell already collapsed",this),new Error("Cell already collapsed")}getNeighbors(){return{top:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y-1),right:this.grid.cells.find(e=>e.x===this.x+1&&e.y===this.y),bottom:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y+1),left:this.grid.cells.find(e=>e.x===this.x-1&&e.y===this.y)}}evaluate(){var o,n,s,l;if(this.collapsed)return;const e=this.getNeighbors();(o=e.top)!=null&&o.collapsed&&(this.options=this.options.filter(a=>{var g,p;return a.sockets.top===A((p=(g=e.top)==null?void 0:g.collapsed)==null?void 0:p.sockets.bottom)})),(n=e.right)!=null&&n.collapsed&&(this.options=this.options.filter(a=>{var g,p;return a.sockets.right===A((p=(g=e.right)==null?void 0:g.collapsed)==null?void 0:p.sockets.left)})),(s=e.bottom)!=null&&s.collapsed&&(this.options=this.options.filter(a=>{var g,p;return a.sockets.bottom===A((p=(g=e.bottom)==null?void 0:g.collapsed)==null?void 0:p.sockets.top)})),(l=e.left)!=null&&l.collapsed&&(this.options=this.options.filter(a=>{var g,p;return a.sockets.left===A((p=(g=e.left)==null?void 0:g.collapsed)==null?void 0:p.sockets.right)}))}}var k,b;class V{constructor(e,o){m(this,k);m(this,b);u(this,k,o),u(this,b,[]);for(let n=0;n<e;n++)for(let s=0;s<e;s++)f(this,b).push(new q(this,n,s,[...o]))}get tiles(){return f(this,k)}get cells(){return f(this,b)}collapseNextCell(){const e=this.cells.filter(s=>!s.collapsed).sort((s,l)=>s.options.length-l.options.length),o=e.filter(s=>s.options.length===e[0].options.length),n=o[Math.floor(Math.random()*o.length)];if(n.options.length===0)throw console.log("No options left",n),x(),new Error("No options left");return n.collapse(),n}evaluate(){this.cells.forEach(e=>{e.evaluate()})}}k=new WeakMap,b=new WeakMap;var E,I,v,T;class r{constructor(e,o,n=0,s=null){m(this,E);m(this,I);m(this,v);m(this,T);u(this,I,e),u(this,E,o),u(this,v,n),u(this,T,s)}get sockets(){return f(this,E)}get image(){return f(this,I)}get rotation(){return f(this,v)}get flipDirection(){return f(this,T)}}E=new WeakMap,I=new WeakMap,v=new WeakMap,T=new WeakMap;const H=[new r("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe-2.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe-3.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe-4.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/1.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/2.png",{top:"BBB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/3.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/4.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/5.png",{top:"BAB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/6.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/7.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/8.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BAB"}),new r("/dungeon/9.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/10.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/11.png",{top:"BAA",right:"AAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/12.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/13.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/14.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BAB"}),new r("/dungeon/15.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/16.png",{top:"BAA",right:"AAB",bottom:"BBB",left:"BBB"}),new r("/dungeon/17.png",{top:"AAB",right:"BAB",bottom:"BBB",left:"BAA"}),new r("/dungeon/18.png",{top:"BAB",right:"BAB",bottom:"BBB",left:"BAB"}),new r("/dungeon/19.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/20.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/21.png",{top:"BAB",right:"BAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/22.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/23.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/24.png",{top:"BAA",right:"AAB",bottom:"BAA",left:"AAB"}),new r("/dungeon/25.png",{top:"BAA",right:"AAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/26.png",{top:"AAA",right:"AAB",bottom:"BAA",left:"AAA"})],_=(t,e)=>{const{top:o,right:n,bottom:s,left:l}=t.sockets,{rotation:a,image:g,flipDirection:p}=t;if(p)throw new Error("Tile already flipped");const W={horizontal:{top:A(s),right:A(n),bottom:A(o),left:A(l)},vertical:{top:A(o),right:A(l),bottom:A(s),left:A(n)}};return new r(g,W[e],a,e)},N=t=>{const{top:e,right:o,bottom:n,left:s}=t.sockets,{rotation:l,image:a,flipDirection:g}=t;return new r(a,{top:s,right:e,bottom:o,left:n},(l+90)%360,g)},L=(t,e)=>{e==="horizontal"?t.scale(1,-1):e==="vertical"&&t.scale(-1,1)},K=[];H.forEach(t=>{const e=N(t),o=N(e),n=N(o);K.push(t,e,o,n)});const J=[];K.forEach(t=>{const e=_(t,"horizontal"),o=_(t,"vertical");J.push(t,e,o)});const tt=J.sort((t,e)=>t.image.localeCompare(e.image)),d=[];tt.forEach(t=>{d.some(e=>e.image===t.image&&e.sockets.top===t.sockets.top&&e.sockets.right===t.sockets.right&&e.sockets.bottom===t.sockets.bottom&&e.sockets.left===t.sockets.left)||d.push(t)});const S=20,h=1e3,B=h/S,F=document.getElementById("map"),M=document.getElementById("debug"),c=F.getContext("2d"),i=M.getContext("2d");if(!c||!i)throw new Error("Could not get canvas context");F.height=h;F.width=h;M.height=d.length*100;M.width=h;let C=new V(S,d),y=-1;const P={};H.forEach(t=>{const e=new Image;e.src=`.${t.image}`,P[t.image]=e});const D=()=>{i.clearRect(0,0,h,h);const t=80;let e=d[0].image,o=0,n=-85;for(let s=0;s<d.length;s++){const l=d[s],a=P[l.image];e!==l.image||n>800?(o+=t+25,n=0,e=l.image):n+=t+5,i.save(),l.rotation&&l.flipDirection?(i.translate(n+t/2,o+t/2),L(i,l.flipDirection),i.rotate(l.rotation*Math.PI/180),i.drawImage(a,-80/2,-80/2,t,t)):l.rotation?(i.translate(n+t/2,o+t/2),i.rotate(l.rotation*Math.PI/180),i.drawImage(a,-80/2,-80/2,t,t)):l.flipDirection?(i.translate(n+t/2,o+t/2),L(i,l.flipDirection),i.drawImage(a,-80/2,-80/2,t,t)):i.drawImage(a,n,o,t,t),i.restore(),i.font="10px Arial",i.fillStyle="orange",i.textAlign="center",i.fillText(l.sockets.top[0],n+t/2-t/4,o+10),i.fillText(l.sockets.top[1],n+t/2,o+10),i.fillText(l.sockets.top[2],n+t/2+t/4,o+10),i.fillText(l.sockets.right[0],n+t-10,o+t/2-t/4),i.fillText(l.sockets.right[1],n+t-10,o+t/2),i.fillText(l.sockets.right[2],n+t-10,o+t/2+t/4),i.fillText(l.sockets.bottom[0],n+t/2+t/4,o+t-10),i.fillText(l.sockets.bottom[1],n+t/2,o+t-10),i.fillText(l.sockets.bottom[2],n+t/2-t/4,o+t-10),i.fillText(l.sockets.left[0],n+10,o+t/2+t/4),i.fillText(l.sockets.left[1],n+10,o+t/2),i.fillText(l.sockets.left[2],n+10,o+t/2-t/4),i.font="10px Arial",i.fillStyle="black",i.textAlign="center",i.fillText(`${l.rotation?`${l.rotation}°`:"0°"} - ${l.flipDirection?l.flipDirection:"original"}`,n+t/2,o+t+15)}},x=()=>{c.clearRect(0,0,h,h),C.cells.forEach(t=>{const e=t.x*B,o=t.y*B,n=t.collapsed;if(n){const s=P[n.image];n.rotation&&n.flipDirection?(c.save(),c.translate(e+B/2,o+B/2),L(c,n.flipDirection),c.rotate(n.rotation*Math.PI/180),c.drawImage(s,-50/2,-50/2,B,B),c.restore()):n.rotation?(c.save(),c.translate(e+B/2,o+B/2),c.rotate(n.rotation*Math.PI/180),c.drawImage(s,-50/2,-50/2,B,B),c.restore()):n.flipDirection?(c.save(),c.translate(e+B/2,o+B/2),L(c,n.flipDirection),c.drawImage(s,-50/2,-50/2,B,B),c.restore()):c.drawImage(s,e,o,B,B)}else t.options.length===0&&(c.fillStyle="red",c.fillRect(e,o,B,B))})},O=()=>{const e=C.collapseNextCell().getNeighbors();Object.values(e).forEach(o=>{o&&!o.collapsed&&o.evaluate()})},Q=()=>{if(!C.cells.some(t=>!t.collapsed)){console.log("All cells collapsed"),cancelAnimationFrame(y);return}O(),x(),y=requestAnimationFrame(Q)},U=()=>{if(C.cells.some(t=>!t.collapsed))O(),U();else{console.log("All cells collapsed"),x();return}};var $;($=document.getElementById("collapseNext"))==null||$.addEventListener("click",()=>{O(),x(),D()});var z;(z=document.getElementById("collapseAllSlow"))==null||z.addEventListener("click",()=>{cancelAnimationFrame(y),Q(),D()});var j;(j=document.getElementById("collapseAllFast"))==null||j.addEventListener("click",()=>{cancelAnimationFrame(y),U(),D()});var G;(G=document.getElementById("reset"))==null||G.addEventListener("click",()=>{cancelAnimationFrame(y),C=new V(S,d),x(),D()});setTimeout(()=>{x(),D()},1e3);
