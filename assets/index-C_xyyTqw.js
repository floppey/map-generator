var X=Object.defineProperty;var P=t=>{throw TypeError(t)};var Y=(t,e,o)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var w=(t,e,o)=>Y(t,typeof e!="symbol"?e+"":e,o),z=(t,e,o)=>e.has(t)||P("Cannot "+o);var f=(t,e,o)=>(z(t,e,"read from private field"),o?o.call(t):e.get(t)),h=(t,e,o)=>e.has(t)?P("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,o),m=(t,e,o,n)=>(z(t,e,"write to private field"),n?n.call(t,o):e.set(t,o),o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(s){if(s.ep)return;s.ep=!0;const l=o(s);fetch(s.href,l)}})();const A=t=>(t??"").split("").reverse().join("");class R{constructor(e,o,n,s){w(this,"x");w(this,"y");w(this,"grid");w(this,"options");w(this,"collapsed");this.grid=e,this.x=o,this.y=n,this.options=s}collapse(){if(!this.collapsed)this.collapsed=this.options[Math.floor(Math.random()*this.options.length)];else throw console.log("Cell already collapsed",this),new Error("Cell already collapsed")}getNeighbors(){return{top:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y-1),right:this.grid.cells.find(e=>e.x===this.x+1&&e.y===this.y),bottom:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y+1),left:this.grid.cells.find(e=>e.x===this.x-1&&e.y===this.y)}}evaluate(){var o,n,s,l;if(this.collapsed)return;const e=this.getNeighbors();(o=e.top)!=null&&o.collapsed&&(this.options=this.options.filter(c=>{var B,a;return c.sockets.top===A((a=(B=e.top)==null?void 0:B.collapsed)==null?void 0:a.sockets.bottom)})),(n=e.right)!=null&&n.collapsed&&(this.options=this.options.filter(c=>{var B,a;return c.sockets.right===A((a=(B=e.right)==null?void 0:B.collapsed)==null?void 0:a.sockets.left)})),(s=e.bottom)!=null&&s.collapsed&&(this.options=this.options.filter(c=>{var B,a;return c.sockets.bottom===A((a=(B=e.bottom)==null?void 0:B.collapsed)==null?void 0:a.sockets.top)})),(l=e.left)!=null&&l.collapsed&&(this.options=this.options.filter(c=>{var B,a;return c.sockets.left===A((a=(B=e.left)==null?void 0:B.collapsed)==null?void 0:a.sockets.right)}))}}var E,u;class H{constructor(e,o,n,s){h(this,E);h(this,u);m(this,E,n),m(this,u,[]);for(let l=0;l<e;l++)for(let c=0;c<o;c++)if(!s&&(l===0||c===0||l===e-1||c===o-1)){let B=[...n];l===0&&(B=B.filter(a=>a.sockets.left==="BBB")),c===0&&(B=B.filter(a=>a.sockets.top==="BBB")),l===e-1&&(B=B.filter(a=>a.sockets.right==="BBB")),c===o-1&&(B=B.filter(a=>a.sockets.bottom==="BBB")),f(this,u).push(new R(this,l,c,[...B]))}else f(this,u).push(new R(this,l,c,[...n]))}get tiles(){return f(this,E)}get cells(){return f(this,u)}collapseNextCell(){const e=this.cells.filter(s=>!s.collapsed).sort((s,l)=>s.options.length-l.options.length),o=e.filter(s=>s.options.length===e[0].options.length),n=o[Math.floor(Math.random()*o.length)];if(n.options.length===0)throw console.log("No options left",n),b(),new Error("No options left");return n.collapse(),n}evaluate(){this.cells.forEach(e=>{e.evaluate()})}}E=new WeakMap,u=new WeakMap;var I,v,T,C;class r{constructor(e,o,n=0,s=null){h(this,I);h(this,v);h(this,T);h(this,C);m(this,v,e),m(this,I,o),m(this,T,n),m(this,C,s)}get sockets(){return f(this,I)}get image(){return f(this,v)}get rotation(){return f(this,T)}get flipDirection(){return f(this,C)}}I=new WeakMap,v=new WeakMap,T=new WeakMap,C=new WeakMap;const K=[new r("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe-2.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe-3.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/0-dupe-4.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/1.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/2.png",{top:"BBB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/3.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/4.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/5.png",{top:"BAB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/6.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/7.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/8.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BAB"}),new r("/dungeon/9.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/10.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/11.png",{top:"BAA",right:"AAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/12.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/13.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/14.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BAB"}),new r("/dungeon/15.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/16.png",{top:"BAA",right:"AAB",bottom:"BBB",left:"BBB"}),new r("/dungeon/17.png",{top:"AAB",right:"BAB",bottom:"BBB",left:"BAA"}),new r("/dungeon/18.png",{top:"BAB",right:"BAB",bottom:"BBB",left:"BAB"}),new r("/dungeon/19.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/20.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/21.png",{top:"BAB",right:"BAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/22.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/23.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/24.png",{top:"BAA",right:"AAB",bottom:"BAA",left:"AAB"}),new r("/dungeon/25.png",{top:"BAA",right:"AAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/26.png",{top:"AAA",right:"AAB",bottom:"BAA",left:"AAA"})],$=(t,e)=>{const{top:o,right:n,bottom:s,left:l}=t.sockets,{rotation:c,image:B,flipDirection:a}=t;if(a)throw new Error("Tile already flipped");const W={horizontal:{top:A(s),right:A(n),bottom:A(o),left:A(l)},vertical:{top:A(o),right:A(l),bottom:A(s),left:A(n)}};return new r(B,W[e],c,e)},M=t=>{const{top:e,right:o,bottom:n,left:s}=t.sockets,{rotation:l,image:c,flipDirection:B}=t;return new r(c,{top:s,right:e,bottom:o,left:n},(l+90)%360,B)},L=(t,e)=>{e==="horizontal"?t.scale(1,-1):e==="vertical"&&t.scale(-1,1)},V=[];K.forEach(t=>{const e=M(t),o=M(e),n=M(o);V.push(t,e,o,n)});const J=[];V.forEach(t=>{const e=$(t,"horizontal"),o=$(t,"vertical");J.push(t,e,o)});const q=J.sort((t,e)=>t.image.localeCompare(e.image)),d=[];q.forEach(t=>{d.some(e=>e.image===t.image&&e.sockets.top===t.sockets.top&&e.sockets.right===t.sockets.right&&e.sockets.bottom===t.sockets.bottom&&e.sockets.left===t.sockets.left)||d.push(t)});const p=80;let D=new H(0,0,d,!0);const y=document.getElementById("map"),x=document.getElementById("debug"),g=y.getContext("2d"),i=x.getContext("2d");if(!g||!i)throw new Error("Could not get canvas context");const F=()=>{const t=Number(document.getElementById("height").value),e=Number(document.getElementById("width").value),o=document.getElementById("allowOpenEdges").checked;D=new H(e,t,d,o),y.height=t*p,y.width=e*p};x.height=d.length*100;x.width=1e3;let k=-1;const O={};K.forEach(t=>{const e=new Image;e.src=`.${t.image}`,O[t.image]=e});const N=()=>{i.clearRect(0,0,x.width,x.height);const t=80;let e=d[0].image,o=0,n=-85;for(let s=0;s<d.length;s++){const l=d[s],c=O[l.image];e!==l.image||n>800?(o+=t+25,n=0,e=l.image):n+=t+5,i.save(),l.rotation&&l.flipDirection?(i.translate(n+t/2,o+t/2),L(i,l.flipDirection),i.rotate(l.rotation*Math.PI/180),i.drawImage(c,-80/2,-80/2,t,t)):l.rotation?(i.translate(n+t/2,o+t/2),i.rotate(l.rotation*Math.PI/180),i.drawImage(c,-80/2,-80/2,t,t)):l.flipDirection?(i.translate(n+t/2,o+t/2),L(i,l.flipDirection),i.drawImage(c,-80/2,-80/2,t,t)):i.drawImage(c,n,o,t,t),i.restore(),i.font="10px Arial",i.fillStyle="orange",i.textAlign="center",i.fillText(l.sockets.top[0],n+t/2-t/4,o+10),i.fillText(l.sockets.top[1],n+t/2,o+10),i.fillText(l.sockets.top[2],n+t/2+t/4,o+10),i.fillText(l.sockets.right[0],n+t-10,o+t/2-t/4),i.fillText(l.sockets.right[1],n+t-10,o+t/2),i.fillText(l.sockets.right[2],n+t-10,o+t/2+t/4),i.fillText(l.sockets.bottom[0],n+t/2+t/4,o+t-10),i.fillText(l.sockets.bottom[1],n+t/2,o+t-10),i.fillText(l.sockets.bottom[2],n+t/2-t/4,o+t-10),i.fillText(l.sockets.left[0],n+10,o+t/2+t/4),i.fillText(l.sockets.left[1],n+10,o+t/2),i.fillText(l.sockets.left[2],n+10,o+t/2-t/4),i.font="10px Arial",i.fillStyle="black",i.textAlign="center",i.fillText(`${l.rotation?`${l.rotation}°`:"0°"} - ${l.flipDirection?l.flipDirection:"original"}`,n+t/2,o+t+15)}},b=()=>{g.clearRect(0,0,y.width,y.height),D.cells.forEach(t=>{const e=t.x*p,o=t.y*p,n=t.collapsed;if(n){const s=O[n.image];n.rotation&&n.flipDirection?(g.save(),g.translate(e+p/2,o+p/2),L(g,n.flipDirection),g.rotate(n.rotation*Math.PI/180),g.drawImage(s,-80/2,-80/2,p,p),g.restore()):n.rotation?(g.save(),g.translate(e+p/2,o+p/2),g.rotate(n.rotation*Math.PI/180),g.drawImage(s,-80/2,-80/2,p,p),g.restore()):n.flipDirection?(g.save(),g.translate(e+p/2,o+p/2),L(g,n.flipDirection),g.drawImage(s,-80/2,-80/2,p,p),g.restore()):g.drawImage(s,e,o,p,p)}else t.options.length===0&&(g.fillStyle="red",g.fillRect(e,o,p,p))})},S=()=>{const e=D.collapseNextCell().getNeighbors();Object.values(e).forEach(o=>{o&&!o.collapsed&&o.evaluate()})},Q=()=>{if(!D.cells.some(t=>!t.collapsed)){console.log("All cells collapsed"),cancelAnimationFrame(k);return}S(),b(),k=requestAnimationFrame(Q)},U=()=>{if(D.cells.some(t=>!t.collapsed))S(),U();else{console.log("All cells collapsed"),b();return}};var j;(j=document.getElementById("collapseNext"))==null||j.addEventListener("click",()=>{S(),b(),N()});var G;(G=document.getElementById("collapseAllSlow"))==null||G.addEventListener("click",()=>{cancelAnimationFrame(k),F(),Q(),N()});var Z;(Z=document.getElementById("collapseAllFast"))==null||Z.addEventListener("click",()=>{cancelAnimationFrame(k),F(),U(),N()});var _;(_=document.getElementById("reset"))==null||_.addEventListener("click",()=>{cancelAnimationFrame(k),F(),b(),N()});setTimeout(()=>{F(),b(),N()},1e3);
