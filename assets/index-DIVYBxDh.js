var st=Object.defineProperty;var j=s=>{throw TypeError(s)};var nt=(s,t,i)=>t in s?st(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i;var E=(s,t,i)=>nt(s,typeof t!="symbol"?t+"":t,i),H=(s,t,i)=>t.has(s)||j("Cannot "+i);var p=(s,t,i)=>(H(s,t,"read from private field"),i?i.call(s):t.get(s)),c=(s,t,i)=>t.has(s)?j("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,i),a=(s,t,i,e)=>(H(s,t,"write to private field"),e?e.call(s,i):t.set(s,i),i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&e(l)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();const r=80,M=(s,t)=>{t==="horizontal"?s.scale(1,-1):t==="vertical"&&s.scale(-1,1)},h=s=>(s??"").split("").reverse().join("");var I;class K{constructor(t,i,e,n){c(this,I,!1);E(this,"x");E(this,"y");E(this,"grid");E(this,"options");E(this,"collapsed");this.grid=t,this.x=i,this.y=e,this.options=n,a(this,I,window.location.hostname==="localhost")}collapse(){if(!this.collapsed)this.collapsed=this.options[Math.floor(Math.random()*this.options.length)];else throw console.log("Cell already collapsed",this),new Error("Cell already collapsed")}getNeighbors(){return{top:this.grid.cells.find(t=>t.x===this.x&&t.y===this.y-1),right:this.grid.cells.find(t=>t.x===this.x+1&&t.y===this.y),bottom:this.grid.cells.find(t=>t.x===this.x&&t.y===this.y+1),left:this.grid.cells.find(t=>t.x===this.x-1&&t.y===this.y)}}evaluate(){var i,e,n,o;if(this.collapsed)return;const t=this.getNeighbors();(i=t.top)!=null&&i.collapsed&&(this.options=this.options.filter(l=>{var g,B;return l.sockets.top===h((B=(g=t.top)==null?void 0:g.collapsed)==null?void 0:B.sockets.bottom)})),(e=t.right)!=null&&e.collapsed&&(this.options=this.options.filter(l=>{var g,B;return l.sockets.right===h((B=(g=t.right)==null?void 0:g.collapsed)==null?void 0:B.sockets.left)})),(n=t.bottom)!=null&&n.collapsed&&(this.options=this.options.filter(l=>{var g,B;return l.sockets.bottom===h((B=(g=t.bottom)==null?void 0:g.collapsed)==null?void 0:B.sockets.top)})),(o=t.left)!=null&&o.collapsed&&(this.options=this.options.filter(l=>{var g,B;return l.sockets.left===h((B=(g=t.left)==null?void 0:g.collapsed)==null?void 0:B.sockets.right)}))}render(t,i){const e=this.x*r,n=this.y*r,o=this.collapsed;if(o){const l=i[o.image];o.rotation&&o.flipDirection?(t.save(),t.translate(e+r/2,n+r/2),M(t,o.flipDirection),t.rotate(o.rotation*Math.PI/180),t.drawImage(l,-80/2,-80/2,r,r),t.restore()):o.rotation?(t.save(),t.translate(e+r/2,n+r/2),t.rotate(o.rotation*Math.PI/180),t.drawImage(l,-80/2,-80/2,r,r),t.restore()):o.flipDirection?(t.save(),t.translate(e+r/2,n+r/2),M(t,o.flipDirection),t.drawImage(l,-80/2,-80/2,r,r),t.restore()):t.drawImage(l,e,n,r,r)}else this.options.length===0&&(t.fillStyle="red",t.fillRect(e,n,r,r));if(p(this,I)){t.save();const l=this.collapsed;l&&(t.font="10px Arial",t.fillStyle="orange",t.textAlign="center",t.fillText(l.sockets.top,e+r/2,n+10),t.textAlign="right",t.fillText(l.sockets.right,e+r-5,n+r/2),t.textAlign="center",t.fillText(l.sockets.bottom,e+r/2,n+r-5),t.textAlign="left",t.fillText(l.sockets.left,e+5,n+r/2)),t.strokeStyle="blue",t.strokeRect(e,n,r,r),t.restore()}}}I=new WeakMap;var w,u,b,y,C,D;class Q{constructor(t,i,e,n,o){c(this,w);c(this,u);c(this,b);c(this,y);c(this,C);c(this,D);a(this,w,e),a(this,u,[]),a(this,b,i),a(this,y,t),a(this,C,n),a(this,D,o),this.populate()}get tiles(){return p(this,w)}get cells(){return p(this,u)}populate(){a(this,u,[]);for(let t=0;t<p(this,y);t++)for(let i=0;i<p(this,b);i++)if(!p(this,C)&&(t===0||i===0||t===p(this,y)-1||i===p(this,b)-1)){let e=[...p(this,w)];t===0&&(e=e.filter(n=>n.sockets.left.split("").every(o=>o!=="A"))),i===0&&(e=e.filter(n=>n.sockets.top.split("").every(o=>o!=="A"))),t===p(this,y)-1&&(e=e.filter(n=>n.sockets.right.split("").every(o=>o!=="A"))),i===p(this,b)-1&&(e=e.filter(n=>n.sockets.bottom.split("").every(o=>o!=="A"))),p(this,u).push(new K(this,t,i,[...e]))}else p(this,u).push(new K(this,t,i,[...p(this,w)]))}collapseNextCell(){const t=this.cells.filter(n=>!n.collapsed).sort((n,o)=>n.options.length-o.options.length),i=t.filter(n=>n.options.length===t[0].options.length),e=i[Math.floor(Math.random()*i.length)];if(e.options.length===0){if(console.log("No options left",e),p(this,D))return console.log("Restarting grid"),this.populate(),this.collapseNextCell();throw new Error("No options left")}return e.collapse(),e}evaluate(){this.cells.forEach(t=>{t.evaluate()})}render(t,i){this.cells.forEach(e=>{e.render(t,i)})}}w=new WeakMap,u=new WeakMap,b=new WeakMap,y=new WeakMap,C=new WeakMap,D=new WeakMap;var N,x,L,S;class A{constructor(t,i,e=0,n=null){c(this,N);c(this,x);c(this,L);c(this,S);a(this,x,t),a(this,N,i),a(this,L,e),a(this,S,n)}get sockets(){return p(this,N)}get image(){return p(this,x)}get rotation(){return p(this,L)}get flipDirection(){return p(this,S)}}N=new WeakMap,x=new WeakMap,L=new WeakMap,S=new WeakMap;const it=Array.from({length:10},()=>new A("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"})),U=[...it,new A("/dungeon/1.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BBB"}),new A("/dungeon/2.png",{top:"BBB",right:"BBB",bottom:"BAB",left:"BBB"}),new A("/dungeon/3.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new A("/dungeon/4.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new A("/dungeon/5.png",{top:"BAB",right:"BBB",bottom:"BBB",left:"BBB"}),new A("/dungeon/6.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new A("/dungeon/7.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new A("/dungeon/8.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BAB"}),new A("/dungeon/9.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BBB"}),new A("/dungeon/10.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new A("/dungeon/11.png",{top:"BAA",right:"AAA",bottom:"AAA",left:"AAB"}),new A("/dungeon/12.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new A("/dungeon/13.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BBB"}),new A("/dungeon/14.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BAB"}),new A("/dungeon/15.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new A("/dungeon/16.png",{top:"BAA",right:"AAB",bottom:"BBB",left:"BBB"}),new A("/dungeon/17.png",{top:"AAB",right:"BAB",bottom:"BBB",left:"BAA"}),new A("/dungeon/18.png",{top:"BAB",right:"BAB",bottom:"BBB",left:"BAB"}),new A("/dungeon/19.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new A("/dungeon/20.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BBB"}),new A("/dungeon/21.png",{top:"BAB",right:"BAA",bottom:"AAA",left:"AAB"}),new A("/dungeon/22.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new A("/dungeon/23.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new A("/dungeon/24.png",{top:"BAA",right:"AAB",bottom:"BAA",left:"AAB"}),new A("/dungeon/25.png",{top:"BAA",right:"AAB",bottom:"BAB",left:"BAB"}),new A("/dungeon/26.png",{top:"AAA",right:"AAB",bottom:"BAA",left:"AAA"})],W=[new A("/grass-and-dirt/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new A("/grass-and-dirt/1.png",{top:"AAA",right:"ABA",bottom:"AAA",left:"ABA"}),new A("/grass-and-dirt/2.png",{top:"AAA",right:"ABA",bottom:"ABA",left:"AAA"}),new A("/grass-and-dirt/3.png",{top:"ABA",right:"ABA",bottom:"ABA",left:"ABA"})],X=[new A("/simple/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new A("/simple/1.png",{top:"ABA",right:"AAA",bottom:"ABA",left:"AAA"}),new A("/simple/2.png",{top:"ABA",right:"ABA",bottom:"ABA",left:"ABA"}),new A("/simple/3.png",{top:"ABA",right:"ABA",bottom:"AAA",left:"ABA"}),new A("/simple/4.png",{top:"ABA",right:"AAA",bottom:"AAA",left:"ABA"}),new A("/simple/5.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"ABA"}),new A("/simple/6.png",{top:"AAA",right:"AAB",bottom:"AAA",left:"AAB"}),new A("/simple/7.png",{top:"AAA",right:"BAB",bottom:"AAA",left:"AAB"}),new A("/simple/8.png",{top:"AAA",right:"BAB",bottom:"AAA",left:"BAB"}),new A("/simple/9.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"BAB"}),new A("/simple/10.png",{top:"AAA",right:"ABA",bottom:"AAA",left:"BAB"}),new A("/simple/11.png",{top:"ABA",right:"AAA",bottom:"AAA",left:"BAB"}),new A("/simple/12.png",{top:"AAA",right:"ABA",bottom:"AAA",left:"AAB"}),new A("/simple/13.png",{top:"AAA",right:"AAA",bottom:"ABA",left:"AAB"}),new A("/simple/14.png",{top:"ABA",right:"AAA",bottom:"ABA",left:"AAB"})],$=[new A("/town/grass.png",{top:"AAAA",right:"AAAA",bottom:"AAAA",left:"AAAA"}),new A("/town/dirt.png",{top:"BBBB",right:"BBBB",bottom:"BBBB",left:"BBBB"}),new A("/town/grass-road-1.png",{top:"ABBA",right:"AAAA",bottom:"ABBA",left:"AAAA"}),new A("/town/grass-road-3.png",{top:"AAAA",right:"ABBA",bottom:"ABBA",left:"AAAA"}),new A("/town/grass-road-4.png",{top:"ABBA",right:"ABBA",bottom:"ABBA",left:"ABBA"}),new A("/town/grass-road-5.png",{top:"BAAB",right:"BAAA",bottom:"AAAA",left:"AAAB"}),new A("/town/grass-road-6.png",{top:"AABB",right:"BBBB",bottom:"BBAA",left:"AAAA"}),new A("/town/grass-road-7.png",{top:"BBBB",right:"BAAB",bottom:"BBBB",left:"BAAB"}),new A("/town/house-1.png",{top:"AAAA",right:"AAAA",bottom:"AAAA",left:"AAAA"})],Y=(s,t,i)=>{const e=s.getContext("2d");if(!e)throw new Error("Could not get canvas context");s.height=t.length*100,s.width=1e3,e.clearRect(0,0,s.width,s.height);let n=t[0].image,o=0,l=-85;for(let g=0;g<t.length;g++){const B=t[g],k=i[B.image];n!==B.image||l>800?(o+=r+25,l=0,n=B.image):l+=r+5,e.save(),B.rotation&&B.flipDirection?(e.translate(l+r/2,o+r/2),M(e,B.flipDirection),e.rotate(B.rotation*Math.PI/180),e.drawImage(k,-80/2,-80/2,r,r)):B.rotation?(e.translate(l+r/2,o+r/2),e.rotate(B.rotation*Math.PI/180),e.drawImage(k,-80/2,-80/2,r,r)):B.flipDirection?(e.translate(l+r/2,o+r/2),M(e,B.flipDirection),e.drawImage(k,-80/2,-80/2,r,r)):e.drawImage(k,l,o,r,r),e.restore(),e.font="10px Arial",e.fillStyle="orange",e.textAlign="center",e.fillText(B.sockets.top,l+r/2,o+10),e.textAlign="right",e.fillText(B.sockets.right,l+r-5,o+r/2),e.textAlign="center",e.fillText(B.sockets.bottom,l+r/2,o+r-5),e.textAlign="left",e.fillText(B.sockets.left,l+5,o+r/2),e.font="10px Arial",e.fillStyle="black",e.textAlign="center",e.fillText(`${B.rotation?`${B.rotation}°`:"0°"} - ${B.flipDirection?B.flipDirection:"original"}`,l+r/2,o+r+15)}},O=(s,t,i)=>{const e=s.getContext("2d");if(!e)throw new Error("Could not get canvas context");e.clearRect(0,0,s.width,s.height),t.render(e,i)},V=(s,t)=>{const{top:i,right:e,bottom:n,left:o}=s.sockets,{rotation:l,image:g,flipDirection:B}=s;if(B)throw new Error("Tile already flipped");const k={horizontal:{top:h(n),right:h(e),bottom:h(i),left:h(o)},vertical:{top:h(i),right:h(o),bottom:h(n),left:h(e)}};return new A(g,k[t],l,t)},P=s=>{const{top:t,right:i,bottom:e,left:n}=s.sockets,{rotation:o,image:l,flipDirection:g}=s;return new A(l,{top:n,right:t,bottom:i,left:e},(o+90)%360,g)},T=s=>{const t=[];s.forEach(o=>{const l=P(o),g=P(l),B=P(g);t.push(o,l,g,B)});const i=[];t.forEach(o=>{const l=V(o,"horizontal"),g=V(o,"vertical");i.push(o,l,g)});const e=i.sort((o,l)=>o.image.localeCompare(l.image)),n=[];return e.forEach(o=>{if(o.sockets.top.split("").every(l=>l==="A")&&o.sockets.right.split("").every(l=>l==="A")&&o.sockets.bottom.split("").every(l=>l==="A")&&o.sockets.left.split("").every(l=>l==="A")&&o.rotation===0&&o.flipDirection===null){n.push(o);return}n.some(l=>l.image===o.image&&l.sockets.top===o.sockets.top&&l.sockets.right===o.sockets.right&&l.sockets.bottom===o.sockets.bottom&&l.sockets.left===o.sockets.left)||n.push(o)}),n};let R=-1;const f={};let m=T($),d=new Q(0,0,m,!0,!0);const v=document.getElementById("map"),tt=document.getElementById("debugCanvas"),F=()=>{switch(document.getElementById("tileset").value){case"Town":m=T($);break;case"Dungeon":m=T(U);break;case"Grass and dirt":m=T(W);break;case"Simple":m=T(X);break}const t=Number(document.getElementById("height").value),i=Number(document.getElementById("width").value),e=document.getElementById("allowOpenEdges").checked,n=document.getElementById("autoRestart").checked;d=new Q(i,t,m,e,n),v.height=t*r,v.width=i*r};$.forEach(s=>{const t=new Image;t.src=`.${s.image}`,f[s.image]=t});U.forEach(s=>{const t=new Image;t.src=`.${s.image}`,f[s.image]=t});W.forEach(s=>{const t=new Image;t.src=`.${s.image}`,f[s.image]=t});X.forEach(s=>{const t=new Image;t.src=`.${s.image}`,f[s.image]=t});const z=()=>{const t=d.collapseNextCell().getNeighbors();Object.values(t).forEach(i=>{i&&!i.collapsed&&i.evaluate()})},et=async()=>{if(!d.cells.some(s=>!s.collapsed)){console.log("All cells collapsed");return}setTimeout(()=>{z(),et()},100)},G=async()=>{O(v,d,f),d.cells.some(s=>!s.collapsed)&&(R=requestAnimationFrame(G))},ot=async()=>{d.cells.some(s=>!s.collapsed)?setTimeout(()=>{z(),ot()},0):console.log("All cells collapsed")};var Z;(Z=document.getElementById("collapseNext"))==null||Z.addEventListener("click",()=>{z(),O(v,d,f),Y(tt,m,f)});var _;(_=document.getElementById("collapseAllSlow"))==null||_.addEventListener("click",()=>{cancelAnimationFrame(R),F(),et(),G()});var q;(q=document.getElementById("collapseAllFast"))==null||q.addEventListener("click",()=>{cancelAnimationFrame(R),F(),ot(),G()});var J;(J=document.getElementById("reset"))==null||J.addEventListener("click",()=>{cancelAnimationFrame(R),F(),O(v,d,f)});setTimeout(()=>{F(),O(v,d,f),Y(tt,m,f)},1e3);
