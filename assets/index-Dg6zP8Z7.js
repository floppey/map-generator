var X=Object.defineProperty;var R=t=>{throw TypeError(t)};var Y=(t,e,o)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var w=(t,e,o)=>Y(t,typeof e!="symbol"?e+"":e,o),Z=(t,e,o)=>e.has(t)||R("Cannot "+o);var h=(t,e,o)=>(Z(t,e,"read from private field"),o?o.call(t):e.get(t)),A=(t,e,o)=>e.has(t)?R("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,o),u=(t,e,o,s)=>(Z(t,e,"write to private field"),s?s.call(t,o):e.set(t,o),o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(n){if(n.ep)return;n.ep=!0;const l=o(n);fetch(n.href,l)}})();const f=t=>(t??"").split("").reverse().join("");class q{constructor(e,o,s,n){w(this,"x");w(this,"y");w(this,"grid");w(this,"options");w(this,"collapsed");this.grid=e,this.x=o,this.y=s,this.options=n}collapse(){if(!this.collapsed)this.collapsed=this.options[Math.floor(Math.random()*this.options.length)];else throw console.log("Cell already collapsed",this),new Error("Cell already collapsed")}getNeighbors(){return{top:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y-1),right:this.grid.cells.find(e=>e.x===this.x+1&&e.y===this.y),bottom:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y+1),left:this.grid.cells.find(e=>e.x===this.x-1&&e.y===this.y)}}evaluate(){var o,s,n,l;if(this.collapsed)return;const e=this.getNeighbors();(o=e.top)!=null&&o.collapsed&&(this.options=this.options.filter(c=>{var g,p;return c.sockets.top===f((p=(g=e.top)==null?void 0:g.collapsed)==null?void 0:p.sockets.bottom)})),(s=e.right)!=null&&s.collapsed&&(this.options=this.options.filter(c=>{var g,p;return c.sockets.right===f((p=(g=e.right)==null?void 0:g.collapsed)==null?void 0:p.sockets.left)})),(n=e.bottom)!=null&&n.collapsed&&(this.options=this.options.filter(c=>{var g,p;return c.sockets.bottom===f((p=(g=e.bottom)==null?void 0:g.collapsed)==null?void 0:p.sockets.top)})),(l=e.left)!=null&&l.collapsed&&(this.options=this.options.filter(c=>{var g,p;return c.sockets.left===f((p=(g=e.left)==null?void 0:g.collapsed)==null?void 0:p.sockets.right)}))}}var E,b;class j{constructor(e,o){A(this,E);A(this,b);u(this,E,o),u(this,b,[]);for(let s=0;s<e;s++)for(let n=0;n<e;n++)h(this,b).push(new q(this,s,n,[...o]))}get tiles(){return h(this,E)}get cells(){return h(this,b)}collapseNextCell(){const e=this.cells.filter(n=>!n.collapsed).sort((n,l)=>n.options.length-l.options.length),o=e.filter(n=>n.options.length===e[0].options.length),s=o[Math.floor(Math.random()*o.length)];if(s.options.length===0)throw console.log("No options left",s),y(),new Error("No options left");s.collapse()}evaluate(){this.cells.forEach(e=>{e.evaluate()})}}E=new WeakMap,b=new WeakMap;var I,v,T,C;class r{constructor(e,o,s=0,n=null){A(this,I);A(this,v);A(this,T);A(this,C);u(this,v,e),u(this,I,o),u(this,T,s),u(this,C,n)}get sockets(){return h(this,I)}get image(){return h(this,v)}get rotation(){return h(this,T)}get flipDirection(){return h(this,C)}}I=new WeakMap,v=new WeakMap,T=new WeakMap,C=new WeakMap;const H=[new r("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/dungeon/1.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/2.png",{top:"BBB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/3.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/4.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/5.png",{top:"BAB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/6.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/7.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/8.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BAB"}),new r("/dungeon/9.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/10.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/11.png",{top:"BAA",right:"AAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/12.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/13.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/14.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BAB"}),new r("/dungeon/15.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/16.png",{top:"BAA",right:"AAB",bottom:"BBB",left:"BBB"}),new r("/dungeon/17.png",{top:"AAB",right:"BAB",bottom:"BBB",left:"BAA"}),new r("/dungeon/18.png",{top:"BAB",right:"BAB",bottom:"BBB",left:"BAB"}),new r("/dungeon/19.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/20.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BBB"})],_=(t,e)=>{const{top:o,right:s,bottom:n,left:l}=t.sockets,{rotation:c,image:g,flipDirection:p}=t;if(p)throw new Error("Tile already flipped");const W={horizontal:{top:f(n),right:f(s),bottom:f(o),left:f(l)},vertical:{top:f(o),right:f(l),bottom:f(n),left:f(s)}};return new r(g,W[e],c,e)},N=t=>{const{top:e,right:o,bottom:s,left:n}=t.sockets,{rotation:l,image:c,flipDirection:g}=t;return new r(c,{top:n,right:e,bottom:o,left:s},(l+90)%360,g)},L=(t,e)=>{e==="horizontal"?t.scale(1,-1):e==="vertical"&&t.scale(-1,1)},K=[];H.forEach(t=>{const e=N(t),o=N(e),s=N(o);K.push(t,e,o,s)});const J=[];K.forEach(t=>{const e=_(t,"horizontal"),o=_(t,"vertical");J.push(t,e,o)});const tt=J.sort((t,e)=>t.image.localeCompare(e.image)),d=[];tt.forEach(t=>{d.some(e=>e.image===t.image&&e.sockets.top===t.sockets.top&&e.sockets.right===t.sockets.right&&e.sockets.bottom===t.sockets.bottom&&e.sockets.left===t.sockets.left)||d.push(t)});const S=20,m=1e3,B=m/S,F=document.getElementById("map"),M=document.getElementById("debug"),a=F.getContext("2d"),i=M.getContext("2d");if(!a||!i)throw new Error("Could not get canvas context");F.height=m;F.width=m;M.height=d.length*100;M.width=m;let x=new j(S,d),k=-1;const P={};H.forEach(t=>{const e=new Image;e.src=`.${t.image}`,P[t.image]=e});const D=()=>{i.clearRect(0,0,m,m);const t=80;let e=d[0].image,o=0,s=-85;for(let n=0;n<d.length;n++){const l=d[n],c=P[l.image];e!==l.image||s>800?(o+=t+25,s=0,e=l.image):s+=t+5,i.save(),l.rotation&&l.flipDirection?(i.translate(s+t/2,o+t/2),L(i,l.flipDirection),i.rotate(l.rotation*Math.PI/180),i.drawImage(c,-80/2,-80/2,t,t)):l.rotation?(i.translate(s+t/2,o+t/2),i.rotate(l.rotation*Math.PI/180),i.drawImage(c,-80/2,-80/2,t,t)):l.flipDirection?(i.translate(s+t/2,o+t/2),L(i,l.flipDirection),i.drawImage(c,-80/2,-80/2,t,t)):i.drawImage(c,s,o,t,t),i.restore(),i.font="10px Arial",i.fillStyle="orange",i.textAlign="center",i.fillText(l.sockets.top[0],s+t/2-t/4,o+10),i.fillText(l.sockets.top[1],s+t/2,o+10),i.fillText(l.sockets.top[2],s+t/2+t/4,o+10),i.fillText(l.sockets.right[0],s+t-10,o+t/2-t/4),i.fillText(l.sockets.right[1],s+t-10,o+t/2),i.fillText(l.sockets.right[2],s+t-10,o+t/2+t/4),i.fillText(l.sockets.bottom[0],s+t/2+t/4,o+t-10),i.fillText(l.sockets.bottom[1],s+t/2,o+t-10),i.fillText(l.sockets.bottom[2],s+t/2-t/4,o+t-10),i.fillText(l.sockets.left[0],s+10,o+t/2+t/4),i.fillText(l.sockets.left[1],s+10,o+t/2),i.fillText(l.sockets.left[2],s+10,o+t/2-t/4),i.font="10px Arial",i.fillStyle="black",i.textAlign="center",i.fillText(`${l.rotation?`${l.rotation}°`:"0°"} - ${l.flipDirection?l.flipDirection:"original"}`,s+t/2,o+t+15)}},y=()=>{a.clearRect(0,0,m,m),x.cells.forEach(t=>{const e=t.x*B,o=t.y*B,s=t.collapsed;if(s){const n=P[s.image];s.rotation&&s.flipDirection?(a.save(),a.translate(e+B/2,o+B/2),L(a,s.flipDirection),a.rotate(s.rotation*Math.PI/180),a.drawImage(n,-50/2,-50/2,B,B),a.restore()):s.rotation?(a.save(),a.translate(e+B/2,o+B/2),a.rotate(s.rotation*Math.PI/180),a.drawImage(n,-50/2,-50/2,B,B),a.restore()):s.flipDirection?(a.save(),a.translate(e+B/2,o+B/2),L(a,s.flipDirection),a.drawImage(n,-50/2,-50/2,B,B),a.restore()):a.drawImage(n,e,o,B,B)}})},O=()=>{x.collapseNextCell(),x.evaluate()},Q=()=>{if(!x.cells.some(t=>!t.collapsed)){console.log("All cells collapsed"),cancelAnimationFrame(k);return}O(),y(),k=requestAnimationFrame(Q)},U=()=>{if(x.cells.some(t=>!t.collapsed))O(),U();else{console.log("All cells collapsed"),y();return}};var $;($=document.getElementById("collapseNext"))==null||$.addEventListener("click",()=>{O(),y(),D()});var z;(z=document.getElementById("collapseAllSlow"))==null||z.addEventListener("click",()=>{cancelAnimationFrame(k),Q(),D()});var G;(G=document.getElementById("collapseAllFast"))==null||G.addEventListener("click",()=>{cancelAnimationFrame(k),U(),D()});var V;(V=document.getElementById("reset"))==null||V.addEventListener("click",()=>{cancelAnimationFrame(k),x=new j(S,d),y(),D()});setTimeout(()=>{y(),D()},1e3);
