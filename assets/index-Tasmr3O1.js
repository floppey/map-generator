var X=Object.defineProperty;var z=n=>{throw TypeError(n)};var Y=(n,e,i)=>e in n?X(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i;var k=(n,e,i)=>Y(n,typeof e!="symbol"?e+"":e,i),$=(n,e,i)=>e.has(n)||z("Cannot "+i);var g=(n,e,i)=>($(n,e,"read from private field"),i?i.call(n):e.get(n)),A=(n,e,i)=>e.has(n)?z("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,i),h=(n,e,i,t)=>($(n,e,"write to private field"),t?t.call(n,i):e.set(n,i),i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))t(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function i(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(l){if(l.ep)return;l.ep=!0;const o=i(l);fetch(l.href,o)}})();const p=n=>(n??"").split("").reverse().join("");class j{constructor(e,i,t,l){k(this,"x");k(this,"y");k(this,"grid");k(this,"options");k(this,"collapsed");this.grid=e,this.x=i,this.y=t,this.options=l}collapse(){if(!this.collapsed)this.collapsed=this.options[Math.floor(Math.random()*this.options.length)];else throw console.log("Cell already collapsed",this),new Error("Cell already collapsed")}getNeighbors(){return{top:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y-1),right:this.grid.cells.find(e=>e.x===this.x+1&&e.y===this.y),bottom:this.grid.cells.find(e=>e.x===this.x&&e.y===this.y+1),left:this.grid.cells.find(e=>e.x===this.x-1&&e.y===this.y)}}evaluate(){var i,t,l,o;if(this.collapsed)return;const e=this.getNeighbors();(i=e.top)!=null&&i.collapsed&&(this.options=this.options.filter(r=>{var B,c;return r.sockets.top===p((c=(B=e.top)==null?void 0:B.collapsed)==null?void 0:c.sockets.bottom)})),(t=e.right)!=null&&t.collapsed&&(this.options=this.options.filter(r=>{var B,c;return r.sockets.right===p((c=(B=e.right)==null?void 0:B.collapsed)==null?void 0:c.sockets.left)})),(l=e.bottom)!=null&&l.collapsed&&(this.options=this.options.filter(r=>{var B,c;return r.sockets.bottom===p((c=(B=e.bottom)==null?void 0:B.collapsed)==null?void 0:c.sockets.top)})),(o=e.left)!=null&&o.collapsed&&(this.options=this.options.filter(r=>{var B,c;return r.sockets.left===p((c=(B=e.left)==null?void 0:B.collapsed)==null?void 0:c.sockets.right)}))}}var d,m,u,w,E,T;class _{constructor(e,i,t,l,o){A(this,d);A(this,m);A(this,u);A(this,w);A(this,E);A(this,T);h(this,d,t),h(this,m,[]),h(this,u,i),h(this,w,e),h(this,E,l),h(this,T,o),this.populate()}get tiles(){return g(this,d)}get cells(){return g(this,m)}populate(){for(let e=0;e<g(this,w);e++)for(let i=0;i<g(this,u);i++)if(!g(this,E)&&(e===0||i===0||e===g(this,w)-1||i===g(this,u)-1)){let t=[...g(this,d)];e===0&&(t=t.filter(l=>l.sockets.left==="BBB")),i===0&&(t=t.filter(l=>l.sockets.top==="BBB")),e===g(this,w)-1&&(t=t.filter(l=>l.sockets.right==="BBB")),i===g(this,u)-1&&(t=t.filter(l=>l.sockets.bottom==="BBB")),g(this,m).push(new j(this,e,i,[...t]))}else g(this,m).push(new j(this,e,i,[...g(this,d)]))}collapseNextCell(){const e=this.cells.filter(l=>!l.collapsed).sort((l,o)=>l.options.length-o.options.length),i=e.filter(l=>l.options.length===e[0].options.length),t=i[Math.floor(Math.random()*i.length)];if(t.options.length===0){if(console.log("No options left",t),g(this,T))return console.log("Restarting grid"),this.populate(),this.collapseNextCell();throw new Error("No options left")}return t.collapse(),t}evaluate(){this.cells.forEach(e=>{e.evaluate()})}}d=new WeakMap,m=new WeakMap,u=new WeakMap,w=new WeakMap,E=new WeakMap,T=new WeakMap;const s=80;var I,v,C,D;class a{constructor(e,i,t=0,l=null){A(this,I);A(this,v);A(this,C);A(this,D);h(this,v,e),h(this,I,i),h(this,C,t),h(this,D,l)}get sockets(){return g(this,I)}get image(){return g(this,v)}get rotation(){return g(this,C)}get flipDirection(){return g(this,D)}}I=new WeakMap,v=new WeakMap,C=new WeakMap,D=new WeakMap;const q=[new a("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new a("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new a("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new a("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new a("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new a("/dungeon/1.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BBB"}),new a("/dungeon/2.png",{top:"BBB",right:"BBB",bottom:"BAB",left:"BBB"}),new a("/dungeon/3.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new a("/dungeon/4.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new a("/dungeon/5.png",{top:"BAB",right:"BBB",bottom:"BBB",left:"BBB"}),new a("/dungeon/6.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new a("/dungeon/7.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new a("/dungeon/8.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BAB"}),new a("/dungeon/9.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BBB"}),new a("/dungeon/10.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new a("/dungeon/11.png",{top:"BAA",right:"AAA",bottom:"AAA",left:"AAB"}),new a("/dungeon/12.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new a("/dungeon/13.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BBB"}),new a("/dungeon/14.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BAB"}),new a("/dungeon/15.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new a("/dungeon/16.png",{top:"BAA",right:"AAB",bottom:"BBB",left:"BBB"}),new a("/dungeon/17.png",{top:"AAB",right:"BAB",bottom:"BBB",left:"BAA"}),new a("/dungeon/18.png",{top:"BAB",right:"BAB",bottom:"BBB",left:"BAB"}),new a("/dungeon/19.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new a("/dungeon/20.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BBB"}),new a("/dungeon/21.png",{top:"BAB",right:"BAA",bottom:"AAA",left:"AAB"}),new a("/dungeon/22.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new a("/dungeon/23.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new a("/dungeon/24.png",{top:"BAA",right:"AAB",bottom:"BAA",left:"AAB"}),new a("/dungeon/25.png",{top:"BAA",right:"AAB",bottom:"BAB",left:"BAB"}),new a("/dungeon/26.png",{top:"AAA",right:"AAB",bottom:"BAA",left:"AAA"})],N=(n,e)=>{e==="horizontal"?n.scale(1,-1):e==="vertical"&&n.scale(-1,1)},J=(n,e,i)=>{const t=n.getContext("2d");if(!t)throw new Error("Could not get canvas context");n.height=e.length*100,n.width=1e3,t.clearRect(0,0,n.width,n.height);let l=e[0].image,o=0,r=-85;for(let B=0;B<e.length;B++){const c=e[B],y=i[c.image];l!==c.image||r>800?(o+=s+25,r=0,l=c.image):r+=s+5,t.save(),c.rotation&&c.flipDirection?(t.translate(r+s/2,o+s/2),N(t,c.flipDirection),t.rotate(c.rotation*Math.PI/180),t.drawImage(y,-80/2,-80/2,s,s)):c.rotation?(t.translate(r+s/2,o+s/2),t.rotate(c.rotation*Math.PI/180),t.drawImage(y,-80/2,-80/2,s,s)):c.flipDirection?(t.translate(r+s/2,o+s/2),N(t,c.flipDirection),t.drawImage(y,-80/2,-80/2,s,s)):t.drawImage(y,r,o,s,s),t.restore(),t.font="10px Arial",t.fillStyle="orange",t.textAlign="center",t.fillText(c.sockets.top[0],r+s/2-s/4,o+10),t.fillText(c.sockets.top[1],r+s/2,o+10),t.fillText(c.sockets.top[2],r+s/2+s/4,o+10),t.fillText(c.sockets.right[0],r+s-10,o+s/2-s/4),t.fillText(c.sockets.right[1],r+s-10,o+s/2),t.fillText(c.sockets.right[2],r+s-10,o+s/2+s/4),t.fillText(c.sockets.bottom[0],r+s/2+s/4,o+s-10),t.fillText(c.sockets.bottom[1],r+s/2,o+s-10),t.fillText(c.sockets.bottom[2],r+s/2-s/4,o+s-10),t.fillText(c.sockets.left[0],r+10,o+s/2+s/4),t.fillText(c.sockets.left[1],r+10,o+s/2),t.fillText(c.sockets.left[2],r+10,o+s/2-s/4),t.font="10px Arial",t.fillStyle="black",t.textAlign="center",t.fillText(`${c.rotation?`${c.rotation}°`:"0°"} - ${c.flipDirection?c.flipDirection:"original"}`,r+s/2,o+s+15)}},L=(n,e,i)=>{const t=n.getContext("2d");if(!t)throw new Error("Could not get canvas context");t.clearRect(0,0,n.width,n.height),e.cells.forEach(l=>{const o=l.x*s,r=l.y*s,B=l.collapsed;if(B){const c=i[B.image];B.rotation&&B.flipDirection?(t.save(),t.translate(o+s/2,r+s/2),N(t,B.flipDirection),t.rotate(B.rotation*Math.PI/180),t.drawImage(c,-80/2,-80/2,s,s),t.restore()):B.rotation?(t.save(),t.translate(o+s/2,r+s/2),t.rotate(B.rotation*Math.PI/180),t.drawImage(c,-80/2,-80/2,s,s),t.restore()):B.flipDirection?(t.save(),t.translate(o+s/2,r+s/2),N(t,B.flipDirection),t.drawImage(c,-80/2,-80/2,s,s),t.restore()):t.drawImage(c,o,r,s,s)}else l.options.length===0&&(t.fillStyle="red",t.fillRect(o,r,s,s))})},G=(n,e)=>{const{top:i,right:t,bottom:l,left:o}=n.sockets,{rotation:r,image:B,flipDirection:c}=n;if(c)throw new Error("Tile already flipped");const y={horizontal:{top:p(l),right:p(t),bottom:p(i),left:p(o)},vertical:{top:p(i),right:p(o),bottom:p(l),left:p(t)}};return new a(B,y[e],r,e)},R=n=>{const{top:e,right:i,bottom:t,left:l}=n.sockets,{rotation:o,image:r,flipDirection:B}=n;return new a(r,{top:l,right:e,bottom:i,left:t},(o+90)%360,B)},tt=n=>{const e=[];n.forEach(o=>{const r=R(o),B=R(r),c=R(B);e.push(o,r,B,c)});const i=[];e.forEach(o=>{const r=G(o,"horizontal"),B=G(o,"vertical");i.push(o,r,B)});const t=i.sort((o,r)=>o.image.localeCompare(r.image)),l=[];return t.forEach(o=>{if(o.sockets.top==="AAA"&&o.sockets.right==="AAA"&&o.sockets.bottom==="AAA"&&o.sockets.left==="AAA"&&o.rotation===0&&o.flipDirection===null){l.push(o);return}l.some(r=>r.image===o.image&&r.sockets.top===o.sockets.top&&r.sockets.right===o.sockets.right&&r.sockets.bottom===o.sockets.bottom&&r.sockets.left===o.sockets.left)||l.push(o)}),console.log(l),l};let M=-1;const b={},O=tt(q);let f=new _(0,0,O,!0,!0);const x=document.getElementById("map"),Q=document.getElementById("debugCanvas"),F=()=>{const n=Number(document.getElementById("height").value),e=Number(document.getElementById("width").value),i=document.getElementById("allowOpenEdges").checked,t=document.getElementById("autoRestart").checked;f=new _(e,n,O,i,t),x.height=n*s,x.width=e*s};q.forEach(n=>{const e=new Image;e.src=`.${n.image}`,b[n.image]=e});const P=()=>{const e=f.collapseNextCell().getNeighbors();Object.values(e).forEach(i=>{i&&!i.collapsed&&i.evaluate()})},U=async()=>{if(!f.cells.some(n=>!n.collapsed)){console.log("All cells collapsed");return}setTimeout(()=>{P(),U()},100)},S=async()=>{L(x,f,b),f.cells.some(n=>!n.collapsed)&&(M=requestAnimationFrame(S))},W=async()=>{f.cells.some(n=>!n.collapsed)?setTimeout(()=>{P(),W()},0):console.log("All cells collapsed")};var H;(H=document.getElementById("collapseNext"))==null||H.addEventListener("click",()=>{P(),L(x,f,b),J(Q,O,b)});var K;(K=document.getElementById("collapseAllSlow"))==null||K.addEventListener("click",()=>{cancelAnimationFrame(M),F(),U(),S()});var V;(V=document.getElementById("collapseAllFast"))==null||V.addEventListener("click",()=>{cancelAnimationFrame(M),F(),W(),S()});var Z;(Z=document.getElementById("reset"))==null||Z.addEventListener("click",()=>{cancelAnimationFrame(M),F(),L(x,f,b)});setTimeout(()=>{F(),L(x,f,b),J(Q,O,b)},1e3);
