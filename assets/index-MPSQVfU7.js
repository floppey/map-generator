var st=Object.defineProperty;var j=n=>{throw TypeError(n)};var nt=(n,t,A)=>t in n?st(n,t,{enumerable:!0,configurable:!0,writable:!0,value:A}):n[t]=A;var y=(n,t,A)=>nt(n,typeof t!="symbol"?t+"":t,A),H=(n,t,A)=>t.has(n)||j("Cannot "+A);var a=(n,t,A)=>(H(n,t,"read from private field"),A?A.call(n):t.get(n)),c=(n,t,A)=>t.has(n)?j("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,A),p=(n,t,A,e)=>(H(n,t,"write to private field"),e?e.call(n,A):t.set(n,A),A);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))e(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function A(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(l){if(l.ep)return;l.ep=!0;const o=A(l);fetch(l.href,o)}})();const s=80,M=(n,t)=>{t==="horizontal"?n.scale(1,-1):t==="vertical"&&n.scale(-1,1)},h=n=>(n??"").split("").reverse().join("");var I;class K{constructor(t,A,e,l){c(this,I,!1);y(this,"x");y(this,"y");y(this,"grid");y(this,"options");y(this,"collapsed");this.grid=t,this.x=A,this.y=e,this.options=l,p(this,I,window.location.hostname==="localhost")}collapse(){if(!this.collapsed)this.collapsed=this.options[Math.floor(Math.random()*this.options.length)];else throw console.log("Cell already collapsed",this),new Error("Cell already collapsed")}getNeighbors(){return{top:this.grid.cells.find(t=>t.x===this.x&&t.y===this.y-1),right:this.grid.cells.find(t=>t.x===this.x+1&&t.y===this.y),bottom:this.grid.cells.find(t=>t.x===this.x&&t.y===this.y+1),left:this.grid.cells.find(t=>t.x===this.x-1&&t.y===this.y)}}evaluate(){var A,e,l,o;if(this.collapsed)return;const t=this.getNeighbors();(A=t.top)!=null&&A.collapsed&&(this.options=this.options.filter(i=>{var g,B;return i.sockets.top===h((B=(g=t.top)==null?void 0:g.collapsed)==null?void 0:B.sockets.bottom)})),(e=t.right)!=null&&e.collapsed&&(this.options=this.options.filter(i=>{var g,B;return i.sockets.right===h((B=(g=t.right)==null?void 0:g.collapsed)==null?void 0:B.sockets.left)})),(l=t.bottom)!=null&&l.collapsed&&(this.options=this.options.filter(i=>{var g,B;return i.sockets.bottom===h((B=(g=t.bottom)==null?void 0:g.collapsed)==null?void 0:B.sockets.top)})),(o=t.left)!=null&&o.collapsed&&(this.options=this.options.filter(i=>{var g,B;return i.sockets.left===h((B=(g=t.left)==null?void 0:g.collapsed)==null?void 0:B.sockets.right)}))}render(t,A){const e=this.x*s,l=this.y*s,o=this.collapsed;if(o){const i=A[o.image];o.rotation&&o.flipDirection?(t.save(),t.translate(e+s/2,l+s/2),M(t,o.flipDirection),t.rotate(o.rotation*Math.PI/180),t.drawImage(i,-80/2,-80/2,s,s),t.restore()):o.rotation?(t.save(),t.translate(e+s/2,l+s/2),t.rotate(o.rotation*Math.PI/180),t.drawImage(i,-80/2,-80/2,s,s),t.restore()):o.flipDirection?(t.save(),t.translate(e+s/2,l+s/2),M(t,o.flipDirection),t.drawImage(i,-80/2,-80/2,s,s),t.restore()):t.drawImage(i,e,l,s,s)}else this.options.length===0&&(t.fillStyle="red",t.fillRect(e,l,s,s));if(a(this,I)){t.save();const i=this.collapsed;i&&(t.font="10px Arial",t.fillStyle="orange",t.textAlign="center",t.fillText(i.sockets.top,e+s/2,l+10),t.textAlign="right",t.fillText(i.sockets.right,e+s-5,l+s/2),t.textAlign="center",t.fillText(i.sockets.bottom,e+s/2,l+s-5),t.textAlign="left",t.fillText(i.sockets.left,e+5,l+s/2)),t.strokeStyle="blue",t.strokeRect(e,l,s,s),t.restore()}}}I=new WeakMap;var w,u,b,C,v,x;class Q{constructor(t,A,e,l,o){c(this,w);c(this,u);c(this,b);c(this,C);c(this,v);c(this,x);p(this,w,e),p(this,u,[]),p(this,b,A),p(this,C,t),p(this,v,l),p(this,x,o),this.populate()}get tiles(){return a(this,w)}get cells(){return a(this,u)}populate(){p(this,u,[]);for(let t=0;t<a(this,C);t++)for(let A=0;A<a(this,b);A++)if(!a(this,v)&&(t===0||A===0||t===a(this,C)-1||A===a(this,b)-1)){let e=[...a(this,w)];t===0&&(e=e.filter(l=>l.sockets.left==="BBB")),A===0&&(e=e.filter(l=>l.sockets.top==="BBB")),t===a(this,C)-1&&(e=e.filter(l=>l.sockets.right==="BBB")),A===a(this,b)-1&&(e=e.filter(l=>l.sockets.bottom==="BBB")),a(this,u).push(new K(this,t,A,[...e]))}else a(this,u).push(new K(this,t,A,[...a(this,w)]))}collapseNextCell(){const t=this.cells.filter(l=>!l.collapsed).sort((l,o)=>l.options.length-o.options.length),A=t.filter(l=>l.options.length===t[0].options.length),e=A[Math.floor(Math.random()*A.length)];if(e.options.length===0){if(console.log("No options left",e),a(this,x))return console.log("Restarting grid"),this.populate(),this.collapseNextCell();throw new Error("No options left")}return e.collapse(),e}evaluate(){this.cells.forEach(t=>{t.evaluate()})}render(t,A){this.cells.forEach(e=>{e.render(t,A)})}}w=new WeakMap,u=new WeakMap,b=new WeakMap,C=new WeakMap,v=new WeakMap,x=new WeakMap;var D,N,L,S;class r{constructor(t,A,e=0,l=null){c(this,D);c(this,N);c(this,L);c(this,S);p(this,N,t),p(this,D,A),p(this,L,e),p(this,S,l)}get sockets(){return a(this,D)}get image(){return a(this,N)}get rotation(){return a(this,L)}get flipDirection(){return a(this,S)}}D=new WeakMap,N=new WeakMap,L=new WeakMap,S=new WeakMap;const it=Array.from({length:10},()=>new r("/dungeon/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"})),U=[...it,new r("/dungeon/1.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/2.png",{top:"BBB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/3.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/4.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/5.png",{top:"BAB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/6.png",{top:"BBB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/7.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/8.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BAB"}),new r("/dungeon/9.png",{top:"BBB",right:"BBB",bottom:"BBB",left:"BBB"}),new r("/dungeon/10.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/11.png",{top:"BAA",right:"AAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/12.png",{top:"BBB",right:"BAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/13.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BBB"}),new r("/dungeon/14.png",{top:"BAA",right:"AAA",bottom:"AAB",left:"BAB"}),new r("/dungeon/15.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/16.png",{top:"BAA",right:"AAB",bottom:"BBB",left:"BBB"}),new r("/dungeon/17.png",{top:"AAB",right:"BAB",bottom:"BBB",left:"BAA"}),new r("/dungeon/18.png",{top:"BAB",right:"BAB",bottom:"BBB",left:"BAB"}),new r("/dungeon/19.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/20.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BBB"}),new r("/dungeon/21.png",{top:"BAB",right:"BAA",bottom:"AAA",left:"AAB"}),new r("/dungeon/22.png",{top:"BAB",right:"BAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/23.png",{top:"BAB",right:"BBB",bottom:"BAB",left:"BBB"}),new r("/dungeon/24.png",{top:"BAA",right:"AAB",bottom:"BAA",left:"AAB"}),new r("/dungeon/25.png",{top:"BAA",right:"AAB",bottom:"BAB",left:"BAB"}),new r("/dungeon/26.png",{top:"AAA",right:"AAB",bottom:"BAA",left:"AAA"})],W=[new r("/grass-and-dirt/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/grass-and-dirt/1.png",{top:"AAA",right:"ABA",bottom:"AAA",left:"ABA"}),new r("/grass-and-dirt/2.png",{top:"AAA",right:"ABA",bottom:"ABA",left:"AAA"}),new r("/grass-and-dirt/3.png",{top:"ABA",right:"ABA",bottom:"ABA",left:"ABA"})],X=[new r("/simple/0.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"AAA"}),new r("/simple/1.png",{top:"ABA",right:"AAA",bottom:"ABA",left:"AAA"}),new r("/simple/2.png",{top:"ABA",right:"ABA",bottom:"ABA",left:"ABA"}),new r("/simple/3.png",{top:"ABA",right:"ABA",bottom:"AAA",left:"ABA"}),new r("/simple/4.png",{top:"ABA",right:"AAA",bottom:"AAA",left:"ABA"}),new r("/simple/5.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"ABA"}),new r("/simple/6.png",{top:"AAA",right:"AAB",bottom:"AAA",left:"AAB"}),new r("/simple/7.png",{top:"AAA",right:"BAB",bottom:"AAA",left:"AAB"}),new r("/simple/8.png",{top:"AAA",right:"BAB",bottom:"AAA",left:"BAB"}),new r("/simple/9.png",{top:"AAA",right:"AAA",bottom:"AAA",left:"BAB"}),new r("/simple/10.png",{top:"AAA",right:"ABA",bottom:"AAA",left:"BAB"}),new r("/simple/11.png",{top:"ABA",right:"AAA",bottom:"AAA",left:"BAB"}),new r("/simple/12.png",{top:"AAA",right:"ABA",bottom:"AAA",left:"AAB"}),new r("/simple/13.png",{top:"AAA",right:"AAA",bottom:"ABA",left:"AAB"}),new r("/simple/14.png",{top:"ABA",right:"AAA",bottom:"ABA",left:"AAB"})],$=[new r("/town/grass.png",{top:"AAAA",right:"AAAA",bottom:"AAAA",left:"AAAA"}),new r("/town/grass-road-1.png",{top:"ABBA",right:"AAAA",bottom:"ABBA",left:"AAAA"}),new r("/town/grass-road-2.png",{top:"ABBA",right:"ABBA",bottom:"ABBA",left:"AAAA"}),new r("/town/grass-road-3.png",{top:"AAAA",right:"ABBA",bottom:"ABBA",left:"AAAA"}),new r("/town/grass-road-4.png",{top:"ABBA",right:"ABBA",bottom:"ABBA",left:"ABBA"}),new r("/town/grass-road-5.png",{top:"BAAB",right:"AAAA",bottom:"AAAA",left:"AAAA"}),new r("/town/grass-road-water-1.png",{top:"ABBC",right:"CCCC",bottom:"CBBA",left:"AAAA"}),new r("/town/grass-road-water-2.png",{top:"ABBC",right:"CCCC",bottom:"CBBA",left:"ABBA"}),new r("/town/grass-road-water-3.png",{top:"CCCC",right:"CCCC",bottom:"CBBA",left:"ABBA"}),new r("/town/water.png",{top:"CCCC",right:"CCCC",bottom:"CCCC",left:"CCCC"})],Y=(n,t,A)=>{const e=n.getContext("2d");if(!e)throw new Error("Could not get canvas context");n.height=t.length*100,n.width=1e3,e.clearRect(0,0,n.width,n.height);let l=t[0].image,o=0,i=-85;for(let g=0;g<t.length;g++){const B=t[g],k=A[B.image];l!==B.image||i>800?(o+=s+25,i=0,l=B.image):i+=s+5,e.save(),B.rotation&&B.flipDirection?(e.translate(i+s/2,o+s/2),M(e,B.flipDirection),e.rotate(B.rotation*Math.PI/180),e.drawImage(k,-80/2,-80/2,s,s)):B.rotation?(e.translate(i+s/2,o+s/2),e.rotate(B.rotation*Math.PI/180),e.drawImage(k,-80/2,-80/2,s,s)):B.flipDirection?(e.translate(i+s/2,o+s/2),M(e,B.flipDirection),e.drawImage(k,-80/2,-80/2,s,s)):e.drawImage(k,i,o,s,s),e.restore(),e.font="10px Arial",e.fillStyle="orange",e.textAlign="center",e.fillText(B.sockets.top[0],i+s/2-s/4,o+10),e.fillText(B.sockets.top[1],i+s/2,o+10),e.fillText(B.sockets.top[2],i+s/2+s/4,o+10),e.fillText(B.sockets.right[0],i+s-10,o+s/2-s/4),e.fillText(B.sockets.right[1],i+s-10,o+s/2),e.fillText(B.sockets.right[2],i+s-10,o+s/2+s/4),e.fillText(B.sockets.bottom[0],i+s/2+s/4,o+s-10),e.fillText(B.sockets.bottom[1],i+s/2,o+s-10),e.fillText(B.sockets.bottom[2],i+s/2-s/4,o+s-10),e.fillText(B.sockets.left[0],i+10,o+s/2+s/4),e.fillText(B.sockets.left[1],i+10,o+s/2),e.fillText(B.sockets.left[2],i+10,o+s/2-s/4),e.font="10px Arial",e.fillStyle="black",e.textAlign="center",e.fillText(`${B.rotation?`${B.rotation}°`:"0°"} - ${B.flipDirection?B.flipDirection:"original"}`,i+s/2,o+s+15)}},O=(n,t,A)=>{const e=n.getContext("2d");if(!e)throw new Error("Could not get canvas context");e.clearRect(0,0,n.width,n.height),t.render(e,A)},V=(n,t)=>{const{top:A,right:e,bottom:l,left:o}=n.sockets,{rotation:i,image:g,flipDirection:B}=n;if(B)throw new Error("Tile already flipped");const k={horizontal:{top:h(l),right:h(e),bottom:h(A),left:h(o)},vertical:{top:h(A),right:h(o),bottom:h(l),left:h(e)}};return new r(g,k[t],i,t)},P=n=>{const{top:t,right:A,bottom:e,left:l}=n.sockets,{rotation:o,image:i,flipDirection:g}=n;return new r(i,{top:l,right:t,bottom:A,left:e},(o+90)%360,g)},E=n=>{const t=[];n.forEach(o=>{const i=P(o),g=P(i),B=P(g);t.push(o,i,g,B)});const A=[];t.forEach(o=>{const i=V(o,"horizontal"),g=V(o,"vertical");A.push(o,i,g)});const e=A.sort((o,i)=>o.image.localeCompare(i.image)),l=[];return e.forEach(o=>{if(o.sockets.top.split("").every(i=>i==="A")&&o.sockets.right.split("").every(i=>i==="A")&&o.sockets.bottom.split("").every(i=>i==="A")&&o.sockets.left.split("").every(i=>i==="A")&&o.rotation===0&&o.flipDirection===null){l.push(o);return}l.some(i=>i.image===o.image&&i.sockets.top===o.sockets.top&&i.sockets.right===o.sockets.right&&i.sockets.bottom===o.sockets.bottom&&i.sockets.left===o.sockets.left)||l.push(o)}),l};let R=-1;const f={};let m=E($),d=new Q(0,0,m,!0,!0);const T=document.getElementById("map"),tt=document.getElementById("debugCanvas"),F=()=>{switch(document.getElementById("tileset").value){case"Town":m=E($);break;case"Dungeon":m=E(U);break;case"Grass and dirt":m=E(W);break;case"Simple":m=E(X);break}const t=Number(document.getElementById("height").value),A=Number(document.getElementById("width").value),e=document.getElementById("allowOpenEdges").checked,l=document.getElementById("autoRestart").checked;d=new Q(A,t,m,e,l),T.height=t*s,T.width=A*s};$.forEach(n=>{const t=new Image;t.src=`.${n.image}`,f[n.image]=t});U.forEach(n=>{const t=new Image;t.src=`.${n.image}`,f[n.image]=t});W.forEach(n=>{const t=new Image;t.src=`.${n.image}`,f[n.image]=t});X.forEach(n=>{const t=new Image;t.src=`.${n.image}`,f[n.image]=t});const z=()=>{const t=d.collapseNextCell().getNeighbors();Object.values(t).forEach(A=>{A&&!A.collapsed&&A.evaluate()})},et=async()=>{if(!d.cells.some(n=>!n.collapsed)){console.log("All cells collapsed");return}setTimeout(()=>{z(),et()},100)},G=async()=>{O(T,d,f),d.cells.some(n=>!n.collapsed)&&(R=requestAnimationFrame(G))},ot=async()=>{d.cells.some(n=>!n.collapsed)?setTimeout(()=>{z(),ot()},0):console.log("All cells collapsed")};var Z;(Z=document.getElementById("collapseNext"))==null||Z.addEventListener("click",()=>{z(),O(T,d,f),Y(tt,m,f)});var _;(_=document.getElementById("collapseAllSlow"))==null||_.addEventListener("click",()=>{cancelAnimationFrame(R),F(),et(),G()});var q;(q=document.getElementById("collapseAllFast"))==null||q.addEventListener("click",()=>{cancelAnimationFrame(R),F(),ot(),G()});var J;(J=document.getElementById("reset"))==null||J.addEventListener("click",()=>{cancelAnimationFrame(R),F(),O(T,d,f)});setTimeout(()=>{F(),O(T,d,f),Y(tt,m,f)},1e3);
